<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FSOCIETY // SECURE TERMINAL</title>

  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Fira+Code:wght@300;500&display=swap" rel="stylesheet">

  <style>
    /* =========================
       MERGED CYBER TERMINAL UI
       ========================= */
    :root{
      --primary:#00ff41;
      --primary-dim:#003b00;
      --danger:#ff003c;
      --danger-dim:#440010;
      --warning:#ffaa00;
      --bg:#020202;
      --panel:#050505;

      --green:#00ff9c;
      --green-soft:#00ff9c55;
      --red:#ff3333;
      --dark:#0a0a0a;
    }

    *{margin:0;padding:0;box-sizing:border-box}
    body{
      background: radial-gradient(circle at center, #0a1a0a 0%, #000 100%);
      color: var(--primary);
      font-family: 'Share Tech Mono', monospace;
      height:100vh; width:100vw;
      overflow:hidden;
    }

    /* CRT overlays (fusion) */
    #crt-screen{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:10000;
      background:
        linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
      background-size: 100% 3px, 3px 100%;
      opacity:.8;
    }
    #scanlines{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:10001;
      background: repeating-linear-gradient(
        to bottom,
        rgba(0,255,156,.05) 0px,
        rgba(0,255,156,.05) 1px,
        transparent 2px,
        transparent 5px
      );
      mix-blend-mode: screen;
      opacity:.6;
    }
    #vignette{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:10002;
      box-shadow: inset 0 0 200px rgba(0,0,0,0.9);
    }

    /* Scrollbar */
    *{
      scrollbar-width:thin;
      scrollbar-color: var(--green) black;
    }
    ::-webkit-scrollbar{width:6px}
    ::-webkit-scrollbar-track{background:black}
    ::-webkit-scrollbar-thumb{background:var(--green); box-shadow:0 0 10px var(--green)}

    /* Grid layout (from 2nd) */
    #grid-container{
      display:grid;
      grid-template-columns: 350px 1fr 380px;
      grid-template-rows: 40px 1fr 200px 30px;
      height:100vh;
      gap:10px;
      padding:10px;
      position:relative;
      z-index:1;
    }

    .panel{
      background: rgba(0, 5, 0, 0.9);
      border:1px solid var(--primary-dim);
      position:relative;
      overflow:hidden;
      backdrop-filter: blur(2px);
    }
    .panel-header{
      background: var(--primary-dim);
      color: var(--primary);
      padding:3px 10px;
      font-size:12px;
      font-weight:bold;
      display:flex;
      justify-content:space-between;
      border-bottom:1px solid var(--primary);
      letter-spacing:1px;
    }

    header.panel{
      grid-column: 1 / 4;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 15px;
      border-bottom:1px solid var(--primary);
    }
    .warning-text{ color: var(--danger); animation: blink .6s infinite; }
    @keyframes blink { 50%{opacity:0} }

    #left-stack{
      grid-row: 2 / 4;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    #main-terminal{
      grid-column: 2 / 3;
      grid-row: 2 / 3;
      display:flex;
      flex-direction:column;
      border:1px solid var(--primary);
      min-width: 0;
    }

    #terminal-output{
      flex-grow:1;
      padding:18px 20px;
      overflow-y:auto;
      font-family:'Fira Code', monospace;
      font-size:13px;
      line-height:1.5;
      scrollbar-width:none;
    }

    .input-line{
      display:flex;
      align-items:center;
      padding:10px 20px;
      background: rgba(0, 40, 0, 0.2);
      border-top:1px solid var(--primary-dim);
      gap:10px;
    }
    #cmd-input{
      background:transparent;
      border:none;
      color:var(--primary);
      font-family:'Fira Code', monospace;
      font-size:15px;
      width:100%;
      outline:none;
    }

    /* Left: matrix logs */
    #log-matrix{
      height:100%;
      font-size:10px;
      color: var(--primary-dim);
      overflow:hidden;
      line-height:1.1;
      padding:8px 10px;
      font-family:'Fira Code', monospace;
      user-select:none;
    }

    /* Radar */
    #radar-panel{ height:300px; }
    #radar-canvas{ width:100%; height:100%; display:block; }

    /* Right visual feed (SAFE placeholder) */
    #visual-feed{
      grid-column: 3 / 4;
      grid-row: 2 / 4;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width: 0;
    }
    .camera-box{
      height:250px;
      background:#000;
      position:relative;
      border:1px solid var(--danger);
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,.6);
      font-family:'Fira Code', monospace;
      font-size:12px;
    }
    .camera-box .hint{
      padding:14px;
      border:1px dashed rgba(255,0,60,.5);
      max-width: 90%;
      text-align:center;
    }

    /* Chat/login module (from 1st), embedded */
    #secure-module{
      margin-top:14px;
      border:1px solid rgba(0,255,156,.35);
      box-shadow: 0 0 18px rgba(0,255,156,.12);
      background: rgba(0,0,0,.35);
      padding:14px;
    }
    #secure-module h2{
      font-size:12px;
      letter-spacing:3px;
      text-align:center;
      color: var(--green);
      margin-bottom:10px;
      animation: flicker 1.6s infinite;
    }
    @keyframes flicker{
      0%,100%{opacity:1}
      50%{opacity:.55}
    }

    .status{
      font-size:12px;
      opacity:.9;
      margin-bottom:6px;
      text-shadow: 0 0 10px rgba(0,255,156,.2);
    }

    .field{
      width:100%;
      margin-top:10px;
      padding:12px;
      background:black;
      border:1px solid var(--green);
      color:var(--green);
      font-family:'Fira Code', monospace;
      outline:none;
      transition:.2s;
    }
    .field:focus{
      box-shadow:0 0 18px var(--green);
    }
    .btn{
      width:100%;
      margin-top:10px;
      padding:12px;
      background:black;
      border:1px solid var(--green);
      color:var(--green);
      font-family:'Fira Code', monospace;
      cursor:pointer;
      letter-spacing:2px;
      position:relative;
      overflow:hidden;
      transition:.2s;
    }
    .btn:hover{
      background:var(--green);
      color:black;
      box-shadow:0 0 25px var(--green);
    }
    .btn::after{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(120deg,transparent,rgba(0,255,156,.35),transparent);
      transform:translateX(-100%);
    }
    .btn:hover::after{ animation: scan .7s linear; }
    @keyframes scan { to{ transform:translateX(100%)} }

    #error{
      color: var(--red);
      text-align:center;
      margin-top:10px;
      font-weight:bold;
      font-family:'Fira Code', monospace;
      font-size:12px;
    }

    #messages{
      height:200px;
      overflow-y:auto;
      border:1px solid var(--green);
      padding:10px;
      margin-top:10px;
      background:#000;
      font-family:'Fira Code', monospace;
      font-size:12px;
    }
    .msg{ margin-bottom:6px; }
    .me{ color:#00ffaa; }
    .sys{ color:#ff5555; font-style:italic; }

    .row{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .row .btn{ width:50%; }

    /* Footer */
    footer.panel{
      grid-column: 1 / 4;
      border-top:1px solid var(--primary-dim);
      display:flex;
      justify-content:space-between;
      font-size:10px;
      padding:0 10px;
      align-items:center;
    }

    /* Cookie banner */
    #cookie-banner{
      position:fixed;
      bottom:0; left:0; right:0;
      background:#020202;
      border-top:1px solid var(--green);
      padding:12px;
      text-align:center;
      font-size:13px;
      z-index:20000;
      color: var(--green);
      font-family:'Fira Code', monospace;
    }
    #cookie-banner .row{
      justify-content:center;
      margin-top:8px;
    }
    #cookie-banner .btn{
      width:auto;
      min-width:140px;
      padding:10px 16px;
      margin-top:0;
    }
    #cookie-banner small{
      display:block;
      opacity:.85;
      margin-top:6px;
    }
  </style>
</head>

<body>
  <div id="crt-screen"></div>
  <div id="scanlines"></div>
  <div id="vignette"></div>

  <!-- Cookie banner (safe: no tracking) -->
  <div id="cookie-banner">
    Ce site utilise uniquement des cookies techniques (session UI).
    <small>Aucune géolocalisation / IP / caméra n’est collectée automatiquement.</small>
    <div class="row">
      <button class="btn" id="accept">ACCEPTER</button>
      <button class="btn" id="decline">REFUSER</button>
    </div>
  </div>

  <div id="grid-container">
    <header class="panel">
      <div><span class="warning-text">●</span> NODE_STABILITY: NOMINAL</div>
      <div id="sys-title">FSOCIETY_DEDICATED_TERMINAL // MERGED_BUILD</div>
      <div id="clock">0000-00-00 00:00:00.000</div>
    </header>

    <div id="left-stack">
      <div class="panel" style="flex-grow: 1;">
        <div class="panel-header"><span>NETWORK_TRAFFIC</span><span>SIM</span></div>
        <div id="log-matrix"></div>
      </div>

      <div class="panel" id="radar-panel">
        <div class="panel-header"><span>GEOLOC_RADAR</span><span>VISUAL_ONLY</span></div>
        <canvas id="radar-canvas"></canvas>
      </div>
    </div>

    <div id="main-terminal" class="panel">
      <div class="panel-header"><span>SYSTEM_CONSOLE</span><span>SAFE_MODE</span></div>

      <div id="terminal-output"></div>

      <!-- Firebase login/chat module embedded -->
      <div id="secure-module">
        <h2>SECURE CHANNEL</h2>
        <div class="status" id="status-line">STATUS: awaiting cookies consent…</div>

        <div id="login" style="display:none">
          <input class="field" id="pseudo" placeholder="Pseudo" autocomplete="off">
          <input class="field" id="code" placeholder="Code d'accès" type="password" autocomplete="off">
          <button class="btn" id="btn-login">CONNEXION</button>
          <div id="error"></div>
        </div>

        <div id="chat" style="display:none">
          <div id="messages"></div>
          <input class="field" id="message" placeholder="> type message" autocomplete="off">
          <button class="btn" id="send">ENVOYER</button>
          <button class="btn" id="logout" style="border-color: var(--danger); color: var(--danger);">DÉCONNEXION</button>
        </div>
      </div>

      <div class="input-line">
        <span>root@fsociety:~#</span>
        <input type="text" id="cmd-input" spellcheck="false" autocomplete="off" />
      </div>
    </div>

    <div id="visual-feed">
      <div class="panel camera-box">
        <div class="hint">
          VISUAL_FEED: DISABLED (SAFE MODE)<br><br>
          Rien n’active la caméra automatiquement.<br>
          Si tu veux un bouton “Activer caméra” avec consentement explicite, dis-moi.
        </div>
      </div>
      <div class="panel" style="flex-grow:1;">
        <div class="panel-header"><span>METADATA</span><span>LOCAL_UI</span></div>
        <div id="metadata-dump" style="padding:10px; font-size:12px; font-family:'Fira Code', monospace;"></div>
      </div>
    </div>

    <footer class="panel">
      <div>LATENCY: 14ms</div>
      <div id="packets-stat">PACKETS_CAPTURED: 0</div>
      <div>AUTHORIZED_USE_ONLY // NO AUTO-LOGGING</div>
    </footer>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <script>
    /* =========================
       SAFE TERMINAL + CHAT MERGE
       ========================= */

    // Firebase config (from your code)
    const firebaseConfig = {
      apiKey: "AIzaSyCpo7up--nfVG4zj_Zeu4kB7pr34ad4ceM",
      authDomain: "lycee-europe-private.firebaseapp.com",
      projectId: "lycee-europe-private",
      storageBucket: "lycee-europe-private.appspot.com",
      messagingSenderId: "259168134432",
      appId: "1:259168134432:web:470f5536d9305b4cf86345"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Collections (from 1st code)
    const messagesRef = db.collection("messages_prives");

    // DOM
    const loginBox = document.getElementById("login");
    const chatBox = document.getElementById("chat");
    const messagesBox = document.getElementById("messages");
    const errorBox = document.getElementById("error");
    const statusLine = document.getElementById("status-line");

    const btnLogin = document.getElementById("btn-login");
    const btnSend = document.getElementById("send");
    const btnLogout = document.getElementById("logout");

    const pseudoEl = document.getElementById("pseudo");
    const codeEl = document.getElementById("code");
    const msgEl = document.getElementById("message");

    let ACCESS_CODE = null;
    let currentPseudo = null;
    let unsub = null;

    // Escaper (from 1st)
    const esc = (s) => String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[m]));

    // Terminal printer (kept safe)
    const Terminal = {
      el: document.getElementById('terminal-output'),
      print(text, type = 'info') {
        const div = document.createElement('div');
        div.style.marginBottom = '6px';
        div.style.whiteSpace = 'pre-wrap';
        div.style.color =
          type === 'error' ? 'var(--danger)' :
          type === 'warn'  ? 'var(--warning)' :
          'var(--primary)';
        this.el.appendChild(div);

        // typewriter effect
        let i = 0;
        const speed = 8;
        const tick = () => {
          if (i < text.length) {
            div.textContent += text.charAt(i++);
            setTimeout(tick, speed);
          } else {
            this.el.scrollTop = this.el.scrollHeight;
          }
        };
        tick();
      },
      clear() { this.el.innerHTML = ''; }
    };

    // Radar (visual only)
    const Radar = {
      canvas: document.getElementById('radar-canvas'),
      ctx: document.getElementById('radar-canvas').getContext('2d'),
      angle: 0,
      init() {
        this.canvas.width = 380;
        this.canvas.height = 300;
        this.render();
      },
      render() {
        const { ctx, canvas } = this;
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;

        ctx.fillStyle = 'rgba(0, 5, 0, 0.12)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.strokeStyle = '#004400';
        ctx.lineWidth = 1;
        for (let i = 1; i < 4; i++) {
          ctx.beginPath();
          ctx.arc(cx, cy, i * 40, 0, Math.PI * 2);
          ctx.stroke();
        }

        const x2 = cx + Math.cos(this.angle) * 120;
        const y2 = cy + Math.sin(this.angle) * 120;
        ctx.strokeStyle = '#00ff41';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(x2, y2);
        ctx.stroke();

        this.angle += 0.03;
        requestAnimationFrame(() => this.render());
      }
    };

    // Matrix log sim
    function startMatrix() {
      const matrix = document.getElementById('log-matrix');
      setInterval(() => {
        const line = document.createElement('div');
        line.textContent = Math.random().toString(16).slice(2).padEnd(32, '0');
        matrix.prepend(line);
        while (matrix.children.length > 60) matrix.lastChild.remove();
      }, 90);
    }

    // Clock + packets sim
    function startHUD() {
      setInterval(() => {
        const d = new Date();
        document.getElementById('clock').textContent =
          d.toISOString().replace('T', ' ').replace('Z', '');
      }, 50);

      let pkts = 0;
      setInterval(() => {
        pkts += Math.floor(Math.random() * 60);
        document.getElementById('packets-stat').textContent = `PACKETS_CAPTURED: ${pkts}`;
      }, 200);
    }

    // Safe local metadata display (no external calls)
    function showLocalMetadata() {
      const md = document.getElementById('metadata-dump');
      md.innerHTML = `
        USER_AGENT: ${esc(navigator.userAgent).slice(0, 70)}...<br>
        RESOLUTION: ${screen.width}x${screen.height}<br>
        CORES: ${navigator.hardwareConcurrency || 'UNDEF'}<br>
        MEMORY: ~${navigator.deviceMemory || 'UNDEF'}GB<br>
        LANG: ${esc(navigator.language || 'UNDEF')}<br>
      `;
    }

    // Load access code from Firestore config/access (from 1st)
    async function loadCode() {
      const d = await db.collection("config").doc("access").get();
      if (d.exists) ACCESS_CODE = d.data().code;
    }

    function systemMessage(text) {
      const div = document.createElement("div");
      div.className = "msg sys";
      div.textContent = "[SYSTEM] " + text;
      messagesBox.appendChild(div);
      messagesBox.scrollTop = messagesBox.scrollHeight;
    }

    function listenMessages() {
      if (unsub) unsub();
      unsub = messagesRef.orderBy("timestamp").onSnapshot(snap => {
        messagesBox.innerHTML = "";
        snap.forEach(doc => {
          const d = doc.data();
          const div = document.createElement("div");
          div.className = "msg";
          div.innerHTML = `<span class="${d.pseudo === currentPseudo ? 'me' : ''}">${esc(d.pseudo)}:</span> ${esc(d.message)}`;
          messagesBox.appendChild(div);
        });
        messagesBox.scrollTop = messagesBox.scrollHeight;
      });
    }

    async function loginFn() {
      const p = pseudoEl.value.trim();
      const c = codeEl.value.trim();
      errorBox.textContent = "";

      if (!p || !c) { errorBox.textContent = "Champs requis."; return; }
      if (!ACCESS_CODE) { errorBox.textContent = "Code indisponible (config)."; return; }
      if (c !== ACCESS_CODE) { errorBox.textContent = "Code incorrect."; return; }

      currentPseudo = p;
      loginBox.style.display = "none";
      chatBox.style.display = "block";
      statusLine.textContent = `STATUS: connected as ${currentPseudo}`;
      systemMessage("Canal sécurisé établi.");
      listenMessages();
      Terminal.print(`>> CHAT ONLINE: user=${currentPseudo}`, 'warn');
    }

    async function sendMessage() {
      const msg = msgEl.value.trim();
      if (!msg) return;

      await messagesRef.add({
        pseudo: currentPseudo || "anon",
        message: msg,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      msgEl.value = "";
    }

    function logoutFn() {
      currentPseudo = null;
      if (unsub) { unsub(); unsub = null; }
      chatBox.style.display = "none";
      loginBox.style.display = "block";
      statusLine.textContent = "STATUS: disconnected";
      Terminal.print(">> LOGOUT: chat session closed.", 'warn');
    }

    // Cookie gating (no tracking)
    const acceptBtn = document.getElementById("accept");
    const declineBtn = document.getElementById("decline");
    const cookieBanner = document.getElementById("cookie-banner");

    acceptBtn.onclick = async () => {
      localStorage.setItem("cookies", "yes");
      cookieBanner.style.display = "none";
      loginBox.style.display = "block";
      statusLine.textContent = "STATUS: ready (enter pseudo + code)";
      Terminal.print(">> COOKIES_ACCEPTED: UI session enabled.");
      try { await loadCode(); } catch(e) { Terminal.print(">> FIRESTORE CONFIG LOAD FAILED.", 'error'); }
    };
    declineBtn.onclick = () => {
      alert("Cookies techniques requis pour la session UI.");
    };

    // Safe command handler
    document.getElementById('cmd-input').addEventListener('keydown', (e) => {
      if (e.key !== 'Enter') return;
      const cmd = e.target.value.trim();
      e.target.value = '';
      if (!cmd) return;

      Terminal.print(`root@fsociety:~# ${cmd}`);

      const c = cmd.toLowerCase();
      if (c === 'help') {
        Terminal.print("COMMANDS: help | clear | login | chat | logout", 'info');
        Terminal.print("TIP: utilise le module 'SECURE CHANNEL' ci-dessus pour te connecter.", 'info');
      } else if (c === 'clear') {
        Terminal.clear();
      } else if (c === 'login') {
        Terminal.print(">> OPENING LOGIN MODULE…", 'warn');
        loginBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
        pseudoEl.focus();
      } else if (c === 'chat') {
        Terminal.print(chatBox.style.display === 'block'
          ? ">> CHAT MODULE: already open."
          : ">> CHAT MODULE: login required.", 'warn');
      } else if (c === 'logout') {
        logoutFn();
      } else {
        Terminal.print(`SYS_ERR: unknown command '${cmd}'. Type 'help'.`, 'error');
      }
    });

    // Init
    window.onload = async () => {
      Radar.init();
      startMatrix();
      startHUD();
      showLocalMetadata();

      Terminal.print(">> BOOT: FSOCIETY MERGED TERMINAL");
      Terminal.print(">> SAFE_MODE: enabled (no auto camera / no IP logging / no exfil).", 'warn');
      Terminal.print(">> Type 'help' for commands.", 'info');

      if (localStorage.getItem("cookies") === "yes") {
        cookieBanner.style.display = "none";
        loginBox.style.display = "block";
        statusLine.textContent = "STATUS: ready (enter pseudo + code)";
        try { await loadCode(); } catch(e) { Terminal.print(">> FIRESTORE CONFIG LOAD FAILED.", 'error'); }
      } else {
        loginBox.style.display = "none";
        statusLine.textContent = "STATUS: awaiting cookies consent…";
      }
    };

    // Wire buttons
    btnLogin.onclick = loginFn;
    btnSend.onclick = sendMessage;
    btnLogout.onclick = logoutFn;
    msgEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });
  </script>
</body>
</html>

