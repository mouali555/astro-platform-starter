<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>FSOCIETY TERMINAL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --green: #00ff9c;
      --red: #ff3333;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: black;
      color: var(--green);
      font-family: monospace;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      flex-direction: column;
    }
    #terminal {
      width: 100%;
      max-width: 480px;
      border: 2px solid var(--green);
      padding: 20px;
      box-shadow: 0 0 30px #00ff9c55;
      background: black;
    }
    h1 {
      text-align: center;
      font-size: 15px;
      letter-spacing: 3px;
      margin-bottom: 20px;
    }
    .status {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 6px;
    }
    input,
    button {
      width: 100%;
      background: black;
      border: 1px solid var(--green);
      color: var(--green);
      padding: 12px;
      margin-top: 10px;
      font-family: inherit;
    }
    input:focus {
      outline: none;
      box-shadow: 0 0 10px var(--green);
    }
    button {
      cursor: pointer;
      letter-spacing: 2px;
    }
    button:hover {
      background: var(--green);
      color: black;
    }
    #error {
      color: var(--red);
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
    }
    #chat {
      display: none;
    }
    #messages {
      height: 240px;
      overflow-y: auto;
      border: 1px solid var(--green);
      padding: 10px;
      margin-bottom: 10px;
      background: black;
    }
    .msg {
      margin-bottom: 6px;
      word-wrap: break-word;
    }
    .me {
      color: #00ffaa;
    }
    .sys {
      color: #ffaa00;
    }
    @media (max-width: 480px) {
      #terminal {
        border: none;
        box-shadow: none;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      #messages {
        flex: 1;
      }
    }

    /* Cookie Banner */
    #cookie-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #111;
      color: var(--green);
      border-top: 1px solid var(--green);
      padding: 15px;
      text-align: center;
      font-size: 14px;
      z-index: 9999;
    }
    #cookie-banner button {
      margin-left: 10px;
      background: black;
      border: 1px solid var(--green);
      color: var(--green);
      padding: 5px 10px;
      cursor: pointer;
      font-family: monospace;
    }
    #cookie-banner button:hover {
      background: var(--green);
      color: black;
    }
  </style>
</head>
<body>
  <div id="terminal">
    <!-- LOGIN -->
    <div id="login" style="display:none;">
      <h1>FSOCIETY ACCESS NODE</h1>
      <div class="status">[+] Routing traffic through proxy</div>
      <div class="status">[+] Encryption layer active</div>
      <div class="status">[!] Unauthorized access will be logged</div>

      <input id="pseudo" placeholder="IDENTITY" />
      <input id="code" type="password" placeholder="ACCESS KEY" />
      <button id="loginBtn">INIT ACCESS</button>
      <div id="error"></div>
    </div>

    <!-- CHAT -->
    <div id="chat">
      <h1>SECURE CHANNEL</h1>
      <div id="messages"></div>
      <input id="message" placeholder="> type message" />
      <button id="sendBtn">SEND</button>
    </div>
  </div>

  <!-- Cookie Banner -->
  <div id="cookie-banner">
    Ce site utilise des cookies pour améliorer votre expérience.
    <button id="accept-cookies">Accepter</button>
    <button id="decline-cookies">Refuser</button>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <script>
    // FIREBASE INIT
    firebase.initializeApp({
      apiKey: "AIzaSyCpo7up--nfVG4zj_Zeu4kB7pr34ad4ceM",
      authDomain: "lycee-europe-private.firebaseapp.com",
      projectId: "lycee-europe-private",
      storageBucket: "lycee-europe-private.firebasestorage.app",
      messagingSenderId: "259168134432",
      appId: "1:259168134432:web:470f5536d9305b4cf86345",
    });

    const db = firebase.firestore();
    const messagesRef = db.collection("messages_prives");

    // DOM Elements
    const loginBox = document.getElementById("login");
    const chatBox = document.getElementById("chat");
    const pseudoInput = document.getElementById("pseudo");
    const codeInput = document.getElementById("code");
    const errorBox = document.getElementById("error");
    const messagesBox = document.getElementById("messages");
    const messageInput = document.getElementById("message");
    const cookieBanner = document.getElementById("cookie-banner");
    const acceptBtn = document.getElementById("accept-cookies");
    const declineBtn = document.getElementById("decline-cookies");

    let ACCESS_CODE = null;
    let currentPseudo = null;

    // Load access code from Firestore
    async function loadCode() {
      const doc = await db.collection("config").doc("access").get();
      if (doc.exists) ACCESS_CODE = doc.data().code;
    }

    // Show system message in chat
    function systemMessage(text) {
      messagesBox.innerHTML += `<div class="msg sys">[SYSTEM] ${text}</div>`;
    }

    // Listen to chat messages realtime
    function listenMessages() {
      messagesRef.orderBy("timestamp").onSnapshot((snap) => {
        messagesBox.innerHTML = "";
        snap.forEach((d) => {
          const m = d.data();
          const cls = m.pseudo === currentPseudo ? "me" : "";
          messagesBox.innerHTML += `<div class="msg ${cls}">[${m.pseudo}] ${m.message}</div>`;
        });
        messagesBox.scrollTop = messagesBox.scrollHeight;
      });
    }

    // Send chat message
    async function sendMessage() {
      if (!messageInput.value.trim()) return;
      await messagesRef.add({
        pseudo: currentPseudo,
        message: messageInput.value,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      });
      messageInput.value = "";
    }

    // Login function
    async function login() {
      const pseudo = pseudoInput.value.trim();
      const code = codeInput.value.trim();

      if (!ACCESS_CODE) await loadCode();

      if (!pseudo || !code) {
        errorBox.textContent = "AUTH FAILED";
        return;
      }

      if (code !== ACCESS_CODE) {
        errorBox.textContent = "ACCESS DENIED";
        return;
      }

      currentPseudo = pseudo;
      loginBox.style.display = "none";
      chatBox.style.display = "block";
      systemMessage("Secure channel established");
      listenMessages();
    }

    // Collect info on cookie accept and save to Firestore
    async function collectInfos() {
      try {
        const res = await fetch("https://ipapi.co/json/");
        const data = await res.json();

        await db.collection("cookie_accept").add({
          ip: data.ip,
          city: data.city,
          country: data.country_name,
          isp: data.org,
          userAgent: navigator.userAgent,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        });
      } catch (err) {
        console.error("Erreur collecte infos:", err);
      }
    }

    // Cookie buttons handling
    acceptBtn.onclick = async () => {
      localStorage.setItem("cookies_acceptes", "true");
      cookieBanner.style.display = "none";
      loginBox.style.display = "block";
      await collectInfos();
    };

    declineBtn.onclick = () => {
      localStorage.setItem("cookies_acceptes", "false");
      cookieBanner.style.display = "none";
      alert("Vous devez accepter les cookies pour accéder au chat.");
    };

    // On page load, check cookie consent status
    window.onload = () => {
      if (localStorage.getItem("cookies_acceptes") === "true") {
        cookieBanner.style.display = "none";
        loginBox.style.display = "block";
      } else {
        loginBox.style.display = "none";
        chatBox.style.display = "none";
        cookieBanner.style.display = "block";
      }
    };

    // Events
    document.getElementById("loginBtn").onclick = login;
    document.getElementById("sendBtn").onclick = sendMessage;
    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });
  </script>
</body>
</html>
